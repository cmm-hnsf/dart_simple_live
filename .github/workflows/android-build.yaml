name: Android Build

on:
  workflow_dispatch:
    inputs:
      build_tv_version:
        description: 'æ˜¯å¦åŒæ—¶æ„å»º TV ç‰ˆæœ¬'
        required: false
        default: 'true'
        type: boolean
      create_release:
        description: 'æ˜¯å¦åˆ›å»º GitHub Release'
        required: false
        default: 'false'
        type: boolean

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # ç­¾å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® Java ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      # è®¾ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          cache: true

      # æ£€æŸ¥ Flutter å®‰è£…
      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      # æ£€æŸ¥æ˜¯å¦æœ‰ç­¾åå¯†é’¥é…ç½®
      - name: Check keystore configuration
        id: check_keystore
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ] && [ -n "${{ secrets.STORE_PASSWORD }}" ] && [ -n "${{ secrets.KEY_PASSWORD }}" ] && [ -n "${{ secrets.KEY_ALIAS }}" ]; then
            echo "has_keystore=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°å®Œæ•´çš„ç­¾åé…ç½®ï¼Œå°†æ„å»ºå·²ç­¾å APK"
          else
            echo "has_keystore=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  æœªæ£€æµ‹åˆ°å®Œæ•´çš„ç­¾åé…ç½®ï¼Œå°†æ„å»ºæœªç­¾å APK"
            echo "è¯·åœ¨ Repository Settings > Secrets ä¸­é…ç½®ä»¥ä¸‹å¯†é’¥ï¼š"
            echo "- KEYSTORE_BASE64: KeyStore æ–‡ä»¶çš„ Base64 ç¼–ç "
            echo "- STORE_PASSWORD: KeyStore å¯†ç "
            echo "- KEY_PASSWORD: å¯†é’¥å¯†ç "
            echo "- KEY_ALIAS: å¯†é’¥åˆ«å"
          fi

      # é…ç½® Android ç­¾åï¼ˆä»…åœ¨æœ‰å®Œæ•´é…ç½®æ—¶æ‰§è¡Œï¼‰
      - name: Configure Android signing
        if: steps.check_keystore.outputs.has_keystore == 'true'
        run: |
          # åˆ›å»º keystore æ–‡ä»¶
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          
          # éªŒè¯ keystore æ–‡ä»¶
          if [ ! -f "keystore.jks" ]; then
            echo "âŒ KeyStore æ–‡ä»¶åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          # éªŒè¯ keystore å’Œåˆ«å
          echo "éªŒè¯ KeyStore å’Œå¯†é’¥åˆ«å..."
          if ! keytool -list -keystore keystore.jks -storepass "${{ secrets.STORE_PASSWORD }}" -alias "${{ secrets.KEY_ALIAS }}" > /dev/null 2>&1; then
            echo "âŒ KeyStore éªŒè¯å¤±è´¥ï¼šæ‰¾ä¸åˆ°åˆ«å '${{ secrets.KEY_ALIAS }}'"
            echo "å¯ç”¨çš„åˆ«ååˆ—è¡¨ï¼š"
            keytool -list -keystore keystore.jks -storepass "${{ secrets.STORE_PASSWORD }}" || true
            exit 1
          fi
          
          # åˆ›å»ºç­¾åé…ç½®æ–‡ä»¶ - simple_live_app
          mkdir -p simple_live_app/android
          cat > simple_live_app/android/key.properties << EOF
          storeFile=../../../keystore.jks
          storePassword=${{ secrets.STORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          EOF
          
          # åˆ›å»ºç­¾åé…ç½®æ–‡ä»¶ - simple_live_tv_app
          if [ "${{ github.event.inputs.build_tv_version }}" == "true" ]; then
            mkdir -p simple_live_tv_app/android
            cat > simple_live_tv_app/android/key.properties << EOF
          storeFile=../../../keystore.jks
          storePassword=${{ secrets.STORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          EOF
          fi
          
          echo "âœ… Android ç­¾åé…ç½®å®Œæˆ"

      # å®‰è£…ä¾èµ– - simple_live_core
      - name: Install dependencies (simple_live_core)
        run: |
          cd simple_live_core
          echo "å®‰è£… simple_live_core ä¾èµ–..."
          flutter pub get
          echo "âœ… simple_live_core ä¾èµ–å®‰è£…å®Œæˆ"

      # å®‰è£…ä¾èµ– - simple_live_app
      - name: Install dependencies (simple_live_app)
        run: |
          cd simple_live_app
          echo "å®‰è£… simple_live_app ä¾èµ–..."
          flutter pub get
          echo "âœ… simple_live_app ä¾èµ–å®‰è£…å®Œæˆ"

      # å®‰è£…ä¾èµ– - simple_live_tv_appï¼ˆå¦‚æœéœ€è¦æ„å»º TV ç‰ˆæœ¬ï¼‰
      - name: Install dependencies (simple_live_tv_app)
        if: github.event.inputs.build_tv_version == 'true'
        run: |
          cd simple_live_tv_app
          echo "å®‰è£… simple_live_tv_app ä¾èµ–..."
          flutter pub get
          echo "âœ… simple_live_tv_app ä¾èµ–å®‰è£…å®Œæˆ"

      # æ„å»º Android APK - simple_live_app
      - name: Build Android APK (simple_live_app)
        run: |
          cd simple_live_app
          echo "å¼€å§‹æ„å»º simple_live_app APK..."
          
          # å¦‚æœæœ‰ç­¾åé…ç½®ï¼Œæ„å»ºå·²ç­¾åç‰ˆæœ¬ï¼›å¦åˆ™æ„å»ºè°ƒè¯•ç‰ˆæœ¬
          if [ "${{ steps.check_keystore.outputs.has_keystore }}" == "true" ]; then
            flutter build apk --release --split-per-abi
          else
            flutter build apk --debug --split-per-abi
          fi
          
          echo "âœ… simple_live_app APK æ„å»ºå®Œæˆ"

      # æ„å»º Android APK - simple_live_tv_appï¼ˆå¦‚æœå¯ç”¨ï¼‰
      - name: Build Android APK (simple_live_tv_app)
        if: github.event.inputs.build_tv_version == 'true'
        run: |
          cd simple_live_tv_app
          echo "å¼€å§‹æ„å»º simple_live_tv_app APK..."
          
          # å¦‚æœæœ‰ç­¾åé…ç½®ï¼Œæ„å»ºå·²ç­¾åç‰ˆæœ¬ï¼›å¦åˆ™æ„å»ºè°ƒè¯•ç‰ˆæœ¬
          if [ "${{ steps.check_keystore.outputs.has_keystore }}" == "true" ]; then
            flutter build apk --release --split-per-abi
          else
            flutter build apk --debug --split-per-abi
          fi
          
          echo "âœ… simple_live_tv_app APK æ„å»ºå®Œæˆ"

      # é‡å‘½åå’Œç»„ç»‡ APK æ–‡ä»¶
      - name: Organize APK files
        run: |
          mkdir -p apk_output
          
          # ç¡®å®šæ„å»ºç±»å‹åç¼€
          if [ "${{ steps.check_keystore.outputs.has_keystore }}" == "true" ]; then
            BUILD_TYPE="release"
            TYPE_SUFFIX="signed"
          else
            BUILD_TYPE="debug"
            TYPE_SUFFIX="unsigned"
          fi
          
          # å¤„ç† simple_live_app APK
          for arch in arm64-v8a armeabi-v7a x86_64; do
            APK_FILE="simple_live_app/build/app/outputs/flutter-apk/app-${arch}-${BUILD_TYPE}.apk"
            if [ -f "$APK_FILE" ]; then
              cp "$APK_FILE" "apk_output/simple_live_app-${arch}-${TYPE_SUFFIX}.apk"
              echo "âœ… å¤åˆ¶: simple_live_app-${arch}-${TYPE_SUFFIX}.apk"
            fi
          done
          
          # å¤„ç† simple_live_tv_app APKï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ "${{ github.event.inputs.build_tv_version }}" == "true" ]; then
            for arch in arm64-v8a armeabi-v7a x86_64; do
              APK_FILE="simple_live_tv_app/build/app/outputs/flutter-apk/app-${arch}-${BUILD_TYPE}.apk"
              if [ -f "$APK_FILE" ]; then
                cp "$APK_FILE" "apk_output/simple_live_tv_app-${arch}-${TYPE_SUFFIX}.apk"
                echo "âœ… å¤åˆ¶: simple_live_tv_app-${arch}-${TYPE_SUFFIX}.apk"
              fi
            done
          fi
          
          # æ˜¾ç¤ºæ„å»ºç»“æœ
          echo ""
          echo "ğŸ“± æ„å»ºå®Œæˆçš„ APK æ–‡ä»¶ï¼š"
          ls -la apk_output/ || echo "æ²¡æœ‰æ‰¾åˆ° APK æ–‡ä»¶"

      # è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æœè¦åˆ›å»º Releaseï¼‰
      - name: Get version info
        if: github.event.inputs.create_release == 'true'
        id: version
        run: |
          # å°è¯•ä»ä¸åŒä½ç½®è·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION="v1.0.0"
          if [ -f "simple_live_app/pubspec.yaml" ]; then
            VERSION=$(grep "version:" simple_live_app/pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
            VERSION="v${VERSION}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "æ„å»ºç‰ˆæœ¬: ${VERSION}"

      # åˆ›å»º GitHub Releaseï¼ˆå¯é€‰ï¼‰
      - name: Create Release
        if: github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}-${{ github.run_number }}
          name: "Android Build ${{ steps.version.outputs.version }}-${{ github.run_number }}"
          body: |
            ## ğŸ“± Android è‡ªåŠ¨æ„å»º
            
            **æ„å»ºä¿¡æ¯:**
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æ„å»ºå·: ${{ github.run_number }}
            - ç­¾åçŠ¶æ€: ${{ steps.check_keystore.outputs.has_keystore == 'true' && 'âœ… å·²ç­¾å' || 'âš ï¸ æœªç­¾å' }}
            - TV ç‰ˆæœ¬: ${{ github.event.inputs.build_tv_version == 'true' && 'âœ… åŒ…å«' || 'âŒ ä¸åŒ…å«' }}
            
            **æ”¯æŒæ¶æ„:**
            - arm64-v8a (æ¨èï¼Œ64ä½ ARM)
            - armeabi-v7a (32ä½ ARM)
            - x86_64 (64ä½ x86ï¼Œæ¨¡æ‹Ÿå™¨)
            
          files: apk_output/*.apk
          draft: false
          prerelease: ${{ steps.check_keystore.outputs.has_keystore != 'true' }}

      # ä¸Šä¼  APK åˆ° Artifacts
      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks-${{ github.run_number }}
          path: apk_output/*.apk
          retention-days: 30

      # æ„å»ºæ‘˜è¦
      - name: Build Summary
        run: |
          echo "## ğŸ‰ Android æ„å»ºå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± æ„å»ºé…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter ç‰ˆæœ¬**: 3.22.x" >> $GITHUB_STEP_SUMMARY
          echo "- **Java ç‰ˆæœ¬**: 17" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºç±»å‹**: ${{ steps.check_keystore.outputs.has_keystore == 'true' && 'Release (å·²ç­¾å)' || 'Debug (æœªç­¾å)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **TV ç‰ˆæœ¬**: ${{ github.event.inputs.build_tv_version == 'true' && 'âœ… å·²æ„å»º' || 'âŒ è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ›å»º Release**: ${{ github.event.inputs.create_release == 'true' && 'âœ… å·²åˆ›å»º' || 'âŒ è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "APK æ–‡ä»¶å·²ä¸Šä¼ åˆ° Artifactsï¼Œæ–‡ä»¶åï¼š\`android-apks-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ—ï¸ æ”¯æŒçš„æ¶æ„" >> $GITHUB_STEP_SUMMARY
          echo "- **arm64-v8a**: 64ä½ ARM (æ¨èï¼Œç°ä»£ Android è®¾å¤‡)" >> $GITHUB_STEP_SUMMARY
          echo "- **armeabi-v7a**: 32ä½ ARM (æ—§è®¾å¤‡å…¼å®¹)" >> $GITHUB_STEP_SUMMARY
          echo "- **x86_64**: 64ä½ x86 (æ¨¡æ‹Ÿå™¨å’Œ x86 è®¾å¤‡)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_keystore.outputs.has_keystore }}" != "true" ]; then
            echo "### âš ï¸ ç­¾åé…ç½®" >> $GITHUB_STEP_SUMMARY
            echo "å½“å‰æ„å»ºçš„æ˜¯**æœªç­¾åç‰ˆæœ¬**ï¼Œå¦‚éœ€å‘å¸ƒåˆ°åº”ç”¨å•†åº—ï¼Œè¯·é…ç½®ä»¥ä¸‹ Secretsï¼š" >> $GITHUB_STEP_SUMMARY
            echo "- \`KEYSTORE_BASE64\`: KeyStore æ–‡ä»¶çš„ Base64 ç¼–ç " >> $GITHUB_STEP_SUMMARY
            echo "- \`STORE_PASSWORD\`: KeyStore å¯†ç " >> $GITHUB_STEP_SUMMARY
            echo "- \`KEY_PASSWORD\`: å¯†é’¥å¯†ç " >> $GITHUB_STEP_SUMMARY
            echo "- \`KEY_ALIAS\`: å¯†é’¥åˆ«å" >> $GITHUB_STEP_SUMMARY
          fi

      # æ¸…ç†å¯†é’¥æ–‡ä»¶
      - name: Cleanup keystore
        if: always() && steps.check_keystore.outputs.has_keystore == 'true'
        run: |
          rm -f keystore.jks
          rm -f simple_live_app/android/key.properties
          rm -f simple_live_tv_app/android/key.properties
          echo "ğŸ§¹ æ¸…ç†å®Œæˆ"
